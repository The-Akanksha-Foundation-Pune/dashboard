{% extends "base.html" %}

{% block title %}Assessments - Empower Institute{% endblock %}

{% block extra_css %}
<style>
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .assessment-card {
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .assessment-card .card-header {
        background-color: #f1f8ff;
        font-weight: bold;
    }

    .comparison-container {
        margin-top: 30px;
    }

    .chart-container {
        height: 400px;
        margin-bottom: 30px;
    }

    .select2-container {
        width: 100% !important;
    }

    .btn-apply-filters {
        background-color: #28a745;
        color: white;
    }

    .btn-reset-filters {
        background-color: #6c757d;
        color: white;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">Assessment Comparison</h1>
    </div>

    <!-- Filter Section -->
    <div class="row">
        <div class="col-12">
            <div class="filter-section">
                <h5 class="mb-3">Select Filters</h5>
                <form id="assessment-filter-form">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="academic-years" class="form-label">Academic Years</label>
                            <select class="form-select select2-multi" id="academic-years" multiple>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="exam-types" class="form-label">Assessment Types</label>
                            <select class="form-select select2-multi" id="exam-types" multiple>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="assessment-types" class="form-label">Data Source</label>
                            <select class="form-select select2-multi" id="assessment-types" multiple>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="subjects" class="form-label">Subjects</label>
                            <select class="form-select select2-multi" id="subjects" multiple>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-reset-filters me-2" id="reset-filters">Reset</button>
                            <button type="button" class="btn btn-apply-filters" id="apply-filters">Apply Filters</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row" id="results-section" style="display: none;">
        <div class="col-12">
            <div class="alert alert-info" id="loading-message">
                <i class="fas fa-spinner fa-spin me-2"></i> Loading assessment data...
            </div>

            <div id="no-data-message" style="display: none;">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i> No assessment data found for the selected filters.
                </div>
            </div>

            <div id="data-container" style="display: none;">
                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card assessment-card">
                            <div class="card-header">Total Assessments</div>
                            <div class="card-body">
                                <h3 id="total-assessments">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card assessment-card">
                            <div class="card-header">Average Score</div>
                            <div class="card-body">
                                <h3 id="average-score">0%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card assessment-card">
                            <div class="card-header">Students</div>
                            <div class="card-body">
                                <h3 id="total-students">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card assessment-card">
                            <div class="card-header">Schools</div>
                            <div class="card-body">
                                <h3 id="total-schools">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Charts -->
                <div class="comparison-container">
                    <h4 class="mb-3">Assessment Comparison</h4>

                    <!-- Academic Year Comparison -->
                    <div class="card assessment-card mb-4">
                        <div class="card-header">Performance by Academic Year</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="academic-year-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Exam Type Comparison -->
                    <div class="card assessment-card mb-4">
                        <div class="card-header">Performance by Assessment Type</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="exam-type-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Subject Comparison -->
                    <div class="card assessment-card">
                        <div class="card-header">Performance by Subject</div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="subject-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Initialize Select2
    $(document).ready(function() {
        $('.select2-multi').select2({
            placeholder: "Select options",
            allowClear: true
        });

        // Load filter options
        loadFilterOptions();

        // Event listeners
        $('#apply-filters').on('click', function() {
            applyFilters();
        });

        $('#reset-filters').on('click', function() {
            resetFilters();
        });
    });

    // Load filter options from the server
    function loadFilterOptions() {
        $.ajax({
            url: "{{ url_for('dashboard.get_assessment_filters') }}",
            type: "GET",
            dataType: "json",
            success: function(data) {
                // Populate academic years
                const academicYearSelect = $('#academic-years');
                academicYearSelect.empty();
                data.academic_years.forEach(year => {
                    academicYearSelect.append(new Option(year, year));
                });

                // Populate exam types
                const examTypeSelect = $('#exam-types');
                examTypeSelect.empty();
                data.exam_types.forEach(type => {
                    examTypeSelect.append(new Option(type, type));
                });

                // Populate assessment types
                const assessmentTypeSelect = $('#assessment-types');
                assessmentTypeSelect.empty();
                data.assessment_types.forEach(type => {
                    const displayName = type === 'standardized' ? 'Standardized' : 'Non-Standardized';
                    assessmentTypeSelect.append(new Option(displayName, type));
                });

                // Populate subjects
                const subjectSelect = $('#subjects');
                subjectSelect.empty();
                data.subjects.forEach(subject => {
                    subjectSelect.append(new Option(subject, subject));
                });

                // Refresh Select2
                $('.select2-multi').trigger('change');
            },
            error: function(xhr, status, error) {
                console.error("Error loading filter options:", error);
                alert("Failed to load filter options. Please try refreshing the page.");
            }
        });
    }

    // Apply filters and fetch assessment data
    function applyFilters() {
        // Show results section and loading message
        $('#results-section').show();
        $('#loading-message').show();
        $('#no-data-message').hide();
        $('#data-container').hide();

        // Get selected filter values
        const filters = {
            academic_years: $('#academic-years').val(),
            exam_types: $('#exam-types').val(),
            assessment_types: $('#assessment-types').val(),
            subjects: $('#subjects').val()
        };

        // Fetch assessment data
        $.ajax({
            url: "{{ url_for('dashboard.get_assessment_data') }}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(filters),
            dataType: "json",
            success: function(data) {
                // Hide loading message
                $('#loading-message').hide();

                if (data.length === 0) {
                    // Show no data message
                    $('#no-data-message').show();
                } else {
                    // Process and display data
                    processAssessmentData(data);
                    $('#data-container').show();
                }
            },
            error: function(xhr, status, error) {
                // Hide loading message and show error
                $('#loading-message').hide();
                console.error("Error fetching assessment data:", error);
                alert("Failed to fetch assessment data. Please try again.");
            }
        });
    }

    // Reset all filters
    function resetFilters() {
        $('.select2-multi').val(null).trigger('change');
        $('#results-section').hide();
    }

    // Process and display assessment data
    function processAssessmentData(data) {
        // Calculate summary statistics
        const totalAssessments = data.length;

        // Calculate average score
        let totalPercentage = 0;
        data.forEach(assessment => {
            if (assessment.percentage !== null) {
                totalPercentage += assessment.percentage;
            }
        });
        const averageScore = totalPercentage / totalAssessments;

        // Count unique students and schools
        const uniqueStudents = new Set();
        const uniqueSchools = new Set();
        data.forEach(assessment => {
            if (assessment.student_id) {
                uniqueStudents.add(assessment.student_id);
            }
            if (assessment.school_name) {
                uniqueSchools.add(assessment.school_name);
            }
        });

        // Update summary cards
        $('#total-assessments').text(totalAssessments.toLocaleString());
        $('#average-score').text(averageScore.toFixed(2) + '%');
        $('#total-students').text(uniqueStudents.size.toLocaleString());
        $('#total-schools').text(uniqueSchools.size.toLocaleString());

        // Generate comparison charts
        generateAcademicYearChart(data);
        generateExamTypeChart(data);
        generateSubjectChart(data);
    }

    // Generate academic year comparison chart
    function generateAcademicYearChart(data) {
        // Group data by academic year
        const yearData = {};
        data.forEach(assessment => {
            if (!assessment.academic_year) return;

            if (!yearData[assessment.academic_year]) {
                yearData[assessment.academic_year] = {
                    totalPercentage: 0,
                    count: 0
                };
            }

            if (assessment.percentage !== null) {
                yearData[assessment.academic_year].totalPercentage += assessment.percentage;
                yearData[assessment.academic_year].count++;
            }
        });

        // Calculate average percentage for each year
        const years = [];
        const averages = [];

        Object.keys(yearData).sort().forEach(year => {
            years.push(year);
            const avg = yearData[year].totalPercentage / yearData[year].count;
            averages.push(avg.toFixed(2));
        });

        // Create chart
        const ctx = document.getElementById('academic-year-chart').getContext('2d');
        if (window.academicYearChart) {
            window.academicYearChart.destroy();
        }

        window.academicYearChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: years,
                datasets: [{
                    label: 'Average Score (%)',
                    data: averages,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    // Generate exam type comparison chart
    function generateExamTypeChart(data) {
        // Group data by exam type
        const typeData = {};
        data.forEach(assessment => {
            if (!assessment.exam_type) return;

            if (!typeData[assessment.exam_type]) {
                typeData[assessment.exam_type] = {
                    totalPercentage: 0,
                    count: 0
                };
            }

            if (assessment.percentage !== null) {
                typeData[assessment.exam_type].totalPercentage += assessment.percentage;
                typeData[assessment.exam_type].count++;
            }
        });

        // Calculate average percentage for each type
        const types = [];
        const averages = [];

        Object.keys(typeData).sort().forEach(type => {
            types.push(type);
            const avg = typeData[type].totalPercentage / typeData[type].count;
            averages.push(avg.toFixed(2));
        });

        // Create chart
        const ctx = document.getElementById('exam-type-chart').getContext('2d');
        if (window.examTypeChart) {
            window.examTypeChart.destroy();
        }

        window.examTypeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: types,
                datasets: [{
                    label: 'Average Score (%)',
                    data: averages,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    // Generate subject comparison chart
    function generateSubjectChart(data) {
        // Group data by subject
        const subjectData = {};
        data.forEach(assessment => {
            if (!assessment.subject_name) return;

            if (!subjectData[assessment.subject_name]) {
                subjectData[assessment.subject_name] = {
                    totalPercentage: 0,
                    count: 0
                };
            }

            if (assessment.percentage !== null) {
                subjectData[assessment.subject_name].totalPercentage += assessment.percentage;
                subjectData[assessment.subject_name].count++;
            }
        });

        // Calculate average percentage for each subject
        const subjects = [];
        const averages = [];

        // Sort subjects by average score (descending)
        const sortedSubjects = Object.keys(subjectData).map(subject => {
            const avg = subjectData[subject].totalPercentage / subjectData[subject].count;
            return {
                subject: subject,
                average: avg
            };
        }).sort((a, b) => b.average - a.average);

        // Take top 10 subjects for readability
        const topSubjects = sortedSubjects.slice(0, 10);

        topSubjects.forEach(item => {
            subjects.push(item.subject);
            averages.push(item.average.toFixed(2));
        });

        // Create chart
        const ctx = document.getElementById('subject-chart').getContext('2d');
        if (window.subjectChart) {
            window.subjectChart.destroy();
        }

        window.subjectChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: subjects,
                datasets: [{
                    label: 'Average Score (%)',
                    data: averages,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // Horizontal bar chart
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
</script>
{% endblock %}
