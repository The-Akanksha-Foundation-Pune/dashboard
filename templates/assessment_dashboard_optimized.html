{% extends "base.html" %}

{% block title %}Leadership Assessment Dashboard - Empower Institute{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        transition: transform 0.3s;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
    }
    .card-header {
        background-color: #212529;
        color: white;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        font-weight: bold;
    }
    .pivot-table-container {
        overflow-x: auto;
        margin-top: 32px;
    }
    .pivot-table {
        min-width: 700px;
        border-collapse: collapse;
        width: 100%;
    }
    .pivot-table th, .pivot-table td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: center;
        font-size: 1rem;
    }
    .pivot-table th {
        background: #f8f9fa;
        font-weight: 600;
    }
    .bg-bucket-red { background: #dc3545 !important; color: #fff !important; }
    .bg-bucket-blue { background: #2596be !important; color: #fff !important; }
    .bg-bucket-green { background: #28a745 !important; color: #fff !important; }
    .bg-bucket-grey { background: #f1f3f4 !important; color: #888 !important; }
    #pivot-loading { display: flex; align-items: center; justify-content: center; height: 180px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Leadership Assessment Dashboard</h1>
    <!-- Filter Row -->
    <div class="row mb-3" id="assessment-filters-row">
        <div class="col-md-2 mb-2">
            <select class="form-select" id="filter-city"><option value="All">All Cities</option></select>
        </div>
        <div class="col-md-2 mb-2">
            <select class="form-select" id="filter-academic-year"><option value="All">All Academic Years</option></select>
    </div>
        <div class="col-md-2 mb-2">
            <select class="form-select" id="filter-assessment-type"><option value="All">All Assessment Types</option></select>
                </div>
        <div class="col-md-2 mb-2">
            <select class="form-select" id="filter-school"><option value="All">All Schools</option></select>
            </div>
        <div class="col-md-2 mb-2">
            <select class="form-select" id="filter-grade"><option value="All">All Grades</option></select>
                </div>
        <div class="col-md-2 mb-2">
            <select class="form-select" id="filter-subject"><option value="All">All Subjects</option></select>
            </div>
        <div class="col-md-2 mb-2">
            <select class="form-select" id="filter-gender">
                <option value="All">All Genders</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
                    </select>
                </div>
            </div>
    <div class="dashboard-card">
                <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold">School vs Grade Pivot Table (Average %)</h6>
                </div>
                <div class="card-body">
            <div id="pivot-loading">
                <div class="spinner-border text-primary" style="width:2.5rem;height:2.5rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
            <div class="pivot-table-container" id="pivot-table-container" style="display:none;"></div>
        </div>
    </div>
    <!-- New School vs Subject Pivot Table Card -->
    <div class="dashboard-card">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold">School vs Subject Pivot Table (Average %)</h6>
        </div>
        <div class="card-body">
            <div id="subject-pivot-loading" style="display:none;">
                <div class="spinner-border text-primary" style="width:2.5rem;height:2.5rem;" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="pivot-table-container" id="subject-pivot-table-container" style="display:none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
let filterOptions = {
    city: 'All',
    academic_year: 'All',
    assessment_type: 'All',
    school: 'All',
    grade: 'All',
    subject: 'All',
    gender: 'All',
    start_date: null,
    end_date: null
};
function getBucketClass(val) {
    if (val === null || val === undefined || isNaN(val)) return 'bg-bucket-grey';
    if (val > 60) return 'bg-bucket-green';
    if (val >= 35) return 'bg-bucket-blue';
    return 'bg-bucket-red';
}
function renderPivotTable(data) {
        const grades = data.grades;
    const schools = Object.keys(data.schools);
    const overall = data.overall.grades;
    let html = '<table class="pivot-table"><thead><tr><th>School</th>';
    grades.forEach(g => { html += `<th>${g}</th>`; });
    html += '<th>Overall</th></tr></thead><tbody>';
    schools.forEach(school => {
        html += `<tr><td style="text-align:left;font-weight:600;">${school}</td>`;
        let rowVals = [];
        grades.forEach(g => {
            const val = data.schools[school].grades[g];
            rowVals.push(val);
            html += `<td class="${getBucketClass(val)}">${val !== null && val !== undefined ? val.toFixed(1) + '%' : '-'}</td>`;
        });
        // Compute overall for this school
        const valid = rowVals.filter(v => v !== null && v !== undefined && !isNaN(v));
        const overallVal = valid.length ? valid.reduce((a,b) => a+b,0)/valid.length : null;
        html += `<td class="${getBucketClass(overallVal)}">${overallVal !== null ? overallVal.toFixed(1) + '%' : '-'}</td>`;
        html += '</tr>';
    });
    // Add city average rows (Mumbai, Pune, Nagpur)
    if (data.cities) {
        ['Mumbai','Pune','Nagpur'].forEach(city => {
            if (data.cities[city]) {
                html += `<tr style="font-weight:700;background:#e9ecef;"><td>${city} Avg</td>`;
                grades.forEach(g => {
                    const val = data.cities[city].grades[g];
                    html += `<td class="${getBucketClass(val)}">${val !== null && val !== undefined ? val.toFixed(1) + '%' : '-'}</td>`;
                });
                // City overall
                const vals = grades.map(g => data.cities[city].grades[g]).filter(v => v !== null && v !== undefined && !isNaN(v));
                const avg = vals.length ? vals.reduce((a,b) => a+b,0)/vals.length : null;
                html += `<td class="${getBucketClass(avg)}">${avg !== null ? avg.toFixed(1) + '%' : '-'}</td></tr>`;
            }
        });
    }
    // Add overall row
    html += '<tr style="font-weight:700;background:#f8f9fa;"><td>Overall</td>';
    grades.forEach(g => {
        const val = overall[g];
        html += `<td class="${getBucketClass(val)}">${val !== null && val !== undefined ? val.toFixed(1) + '%' : '-'}</td>`;
    });
    // Overall of overall
    const overallVals = grades.map(g => overall[g]).filter(v => v !== null && v !== undefined && !isNaN(v));
    const overallAvg = overallVals.length ? overallVals.reduce((a,b) => a+b,0)/overallVals.length : null;
    html += `<td class="${getBucketClass(overallAvg)}">${overallAvg !== null ? overallAvg.toFixed(1) + '%' : '-'}</td></tr>`;
    html += '</tbody></table>';
    document.getElementById('pivot-table-container').innerHTML = html;
}
function loadPivotTable() {
    document.getElementById('pivot-loading').style.display = 'flex';
    document.getElementById('pivot-table-container').style.display = 'none';
    fetch('/assessment/chart/consolidated_performance', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(filterOptions)
    })
        .then(r => r.json())
        .then(data => {
            renderPivotTable(data);
            document.getElementById('pivot-loading').style.display = 'none';
            document.getElementById('pivot-table-container').style.display = '';
        })
        .catch(() => {
            document.getElementById('pivot-loading').innerHTML = '<div class="text-danger">Failed to load data.</div>';
        });
}
function populatePrimaryFilters() {
    fetch('/assessment/get_filters')
        .then(r => r.json())
        .then(data => {
            // City
            const citySel = document.getElementById('filter-city');
            citySel.innerHTML = '<option value="All">All Cities</option>' + data.cities.map(c => `<option value="${c}">${c}</option>`).join('');
            // Academic Years
            const yearSel = document.getElementById('filter-academic-year');
            yearSel.innerHTML = '<option value="All">All Academic Years</option>' + data.academic_years.map(y => `<option value="${y}">${y}</option>`).join('');
            // Assessment Types
            const typeSel = document.getElementById('filter-assessment-type');
            typeSel.innerHTML = '<option value="All">All Assessment Types</option>' + data.assessment_types.map(t => `<option value="${t}">${t}</option>`).join('');
            // Set up change listeners for secondary filters
            citySel.addEventListener('change', onCityFilterChange);
            yearSel.addEventListener('change', onPrimaryFilterChange);
            typeSel.addEventListener('change', onPrimaryFilterChange);
            // Initial secondary filter population
            populateSecondaryFilters();
        });
}
function populateSecondaryFilters() {
    const academic_year = document.getElementById('filter-academic-year').value;
    const assessment_type = document.getElementById('filter-assessment-type').value;
    fetch('/assessment/get_secondary_filters', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({academic_year, assessment_type})
    })
        .then(r => r.json())
        .then(data => {
            // Schools
            const schoolSel = document.getElementById('filter-school');
            schoolSel.innerHTML = '<option value="All">All Schools</option>' + data.schools.map(s => `<option value="${s}">${s}</option>`).join('');
            // Grades
            const gradeSel = document.getElementById('filter-grade');
            gradeSel.innerHTML = '<option value="All">All Grades</option>' + data.grades.map(g => `<option value="${g}">${g}</option>`).join('');
            // Subjects
            const subjectSel = document.getElementById('filter-subject');
            subjectSel.innerHTML = '<option value="All">All Subjects</option>' + data.subjects.map(su => `<option value="${su}">${su}</option>`).join('');
        });
}
function onPrimaryFilterChange() {
    // Update filterOptions and reload secondary filters
    filterOptions.academic_year = document.getElementById('filter-academic-year').value;
    filterOptions.assessment_type = document.getElementById('filter-assessment-type').value;
    populateSecondaryFilters();
    // Reset secondary filters to 'All'
    filterOptions.school = 'All';
    filterOptions.grade = 'All';
    filterOptions.subject = 'All';
    document.getElementById('filter-school').value = 'All';
    document.getElementById('filter-grade').value = 'All';
    document.getElementById('filter-subject').value = 'All';
    loadPivotTable();
}
function onSecondaryFilterChange() {
    filterOptions.school = document.getElementById('filter-school').value;
    filterOptions.grade = document.getElementById('filter-grade').value;
    filterOptions.subject = document.getElementById('filter-subject').value;
    loadPivotTable();
}
function onGenderFilterChange() {
    filterOptions.gender = document.getElementById('filter-gender').value;
    loadPivotTable();
}
function onCityFilterChange() {
    filterOptions.city = document.getElementById('filter-city').value;
    loadPivotTable();
}
function renderSubjectPivotTable(data) {
    const subjects = data.subjects;
    const schools = Object.keys(data.schools);
    const overall = data.overall.subjects;
    let html = '<table class="pivot-table"><thead><tr><th>School</th>';
    subjects.forEach(s => { html += `<th>${s}</th>`; });
    html += '<th>Overall</th></tr></thead><tbody>';
    schools.forEach(school => {
        html += `<tr><td style="text-align:left;font-weight:600;">${school}</td>`;
        let rowVals = [];
        subjects.forEach(s => {
            const val = data.schools[school].subjects[s];
            rowVals.push(val);
            html += `<td class="${getBucketClass(val)}">${val !== null && val !== undefined ? val.toFixed(1) + '%' : '-'}</td>`;
        });
        // Compute overall for this school
        const valid = rowVals.filter(v => v !== null && v !== undefined && !isNaN(v));
        const overallVal = valid.length ? valid.reduce((a,b) => a+b,0)/valid.length : null;
        html += `<td class="${getBucketClass(overallVal)}">${overallVal !== null ? overallVal.toFixed(1) + '%' : '-'}</td>`;
        html += '</tr>';
    });
    // Add city average rows (Mumbai, Pune, Nagpur)
    if (data.cities) {
        ['Mumbai','Pune','Nagpur'].forEach(city => {
            if (data.cities[city]) {
                html += `<tr style="font-weight:700;background:#e9ecef;"><td>${city} Avg</td>`;
                subjects.forEach(s => {
                    const val = data.cities[city].subjects[s];
                    html += `<td class="${getBucketClass(val)}">${val !== null && val !== undefined ? val.toFixed(1) + '%' : '-'}</td>`;
                });
                // City overall
                const vals = subjects.map(s => data.cities[city].subjects[s]).filter(v => v !== null && v !== undefined && !isNaN(v));
                const avg = vals.length ? vals.reduce((a,b) => a+b,0)/vals.length : null;
                html += `<td class="${getBucketClass(avg)}">${avg !== null ? avg.toFixed(1) + '%' : '-'}</td></tr>`;
            }
        });
    }
    // Add overall row
    html += '<tr style="font-weight:700;background:#f8f9fa;"><td>Overall</td>';
    subjects.forEach(s => {
        const val = overall[s];
        html += `<td class="${getBucketClass(val)}">${val !== null && val !== undefined ? val.toFixed(1) + '%' : '-'}</td>`;
    });
    // Overall of overall
    const overallVals = subjects.map(s => overall[s]).filter(v => v !== null && v !== undefined && !isNaN(v));
    const overallAvg = overallVals.length ? overallVals.reduce((a,b) => a+b,0)/overallVals.length : null;
    html += `<td class="${getBucketClass(overallAvg)}">${overallAvg !== null ? overallAvg.toFixed(1) + '%' : '-'}</td></tr>`;
    html += '</tbody></table>';
    document.getElementById('subject-pivot-table-container').innerHTML = html;
}
function loadSubjectPivotTable() {
    document.getElementById('subject-pivot-loading').style.display = 'flex';
    document.getElementById('subject-pivot-table-container').style.display = 'none';
    fetch('/assessment/chart/school_subject_performance', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(filterOptions)
    })
        .then(r => r.json())
        .then(data => {
            renderSubjectPivotTable(data);
            document.getElementById('subject-pivot-loading').style.display = 'none';
            document.getElementById('subject-pivot-table-container').style.display = '';
        })
        .catch(() => {
            document.getElementById('subject-pivot-loading').innerHTML = '<div class="text-danger">Failed to load data.</div>';
        });
}
document.addEventListener('DOMContentLoaded', function() {
    populatePrimaryFilters();
    document.getElementById('filter-city').addEventListener('change', onCityFilterChange);
    document.getElementById('filter-school').addEventListener('change', onSecondaryFilterChange);
    document.getElementById('filter-grade').addEventListener('change', onSecondaryFilterChange);
    document.getElementById('filter-subject').addEventListener('change', onSecondaryFilterChange);
    document.getElementById('filter-gender').addEventListener('change', onGenderFilterChange);
    loadPivotTable();
    loadSubjectPivotTable();
});
</script>
{% endblock %}