{% extends "base.html" %}

{% block title %}Leadership Assessment Dashboard - Empower Institute{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<style>
    .filter-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .dashboard-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        transition: transform 0.3s;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
    }
    .card-header {
        background-color: #4e73df;
        color: white;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        font-weight: bold;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .summary-value {
        font-size: 2rem;
        font-weight: bold;
        color: #4e73df;
    }
    .summary-label {
        color: #5a5c69;
        font-size: 0.8rem;
        text-transform: uppercase;
    }
    .select2-container {
        width: 100% !important;
    }
    /* Using the loading overlay styles from base.html */
</style>
{% endblock %}

{% block content %}
<!-- Using the loading overlay from base.html -->

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Leadership Assessment Dashboard</h1>
    </div>

    <!-- Filters Section -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-3 mb-2">
                <label for="academic-year-filter">Academic Year</label>
                <select id="academic-year-filter" class="form-control">
                    <option value="All">All Academic Years</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label for="subject-filter">Subject</label>
                <select id="subject-filter" class="form-control">
                    <option value="All">All Subjects</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label for="school-filter">School</label>
                <select id="school-filter" class="form-control">
                    <option value="All">All Schools</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label for="assessment-type-filter">Assessment Type</label>
                <select id="assessment-type-filter" class="form-control">
                    <option value="All">All Types</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 mb-2">
                <label for="grade-filter">Grade</label>
                <select id="grade-filter" class="form-control">
                    <option value="All">All Grades</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label for="competency-filter">Competency Level</label>
                <select id="competency-filter" class="form-control">
                    <option value="All">All Competency Levels</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label for="division-filter">Division</label>
                <select id="division-filter" class="form-control">
                    <option value="All">All Divisions</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label for="gender-filter">Gender</label>
                <select id="gender-filter" class="form-control">
                    <option value="All">All Genders</option>
                </select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-2">
                <label for="date-range-filter">Assessment Date Range</label>
                <input type="text" id="date-range-filter" class="form-control" />
            </div>
            <div class="col-md-6 mb-2 d-flex align-items-end">
                <button id="apply-filters" class="btn btn-primary btn-block">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row" id="summary-cards">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2 dashboard-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="summary-label mb-1">Total Students</div>
                            <div class="summary-value" id="total-students">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2 dashboard-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="summary-label mb-1">Average Score</div>
                            <div class="summary-value" id="average-score">0%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2 dashboard-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="summary-label mb-1">Total Assessments</div>
                            <div class="summary-value" id="total-assessments">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2 dashboard-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="summary-label mb-1">Total Schools</div>
                            <div class="summary-value" id="total-schools">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-school fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow mb-4 dashboard-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Overall Student Performance</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="overall-performance-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow mb-4 dashboard-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Average Performance by School</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="school-performance-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow mb-4 dashboard-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Performance by Subject</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="subject-performance-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow mb-4 dashboard-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Gender-based Performance</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="gender-performance-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow mb-4 dashboard-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Trends Over Time</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trends-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow mb-4 dashboard-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Assessment Type Comparison</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="assessment-type-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 4 -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow mb-4 dashboard-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Division-Wise Performance</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="division-performance-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow mb-4 dashboard-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Absent Students Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="absent-students-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top 10 Students Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4 dashboard-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Top 10 Performing Students</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="top-students-table" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Student ID</th>
                                    <th>School</th>
                                    <th>Subject</th>
                                    <th>Grade</th>
                                    <th>Marks</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table content will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2 for all dropdowns
        $('select').select2({
            placeholder: "Select an option",
            allowClear: true
        });

        // Initialize date range picker
        $('#date-range-filter').daterangepicker({
            autoUpdateInput: false,
            locale: {
                cancelLabel: 'Clear'
            }
        });

        $('#date-range-filter').on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('YYYY-MM-DD') + ' to ' + picker.endDate.format('YYYY-MM-DD'));
        });

        $('#date-range-filter').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
        });

        // Load filter options
        loadFilterOptions();

        // Apply filters button click event
        $('#apply-filters').click(function() {
            // Show the loading overlay from base.html
            document.getElementById('loading-overlay').style.display = 'flex';

            // Update loading message
            document.querySelector('#loading-message').textContent = 'Loading data...';

            // Reset progress bar
            const progressBar = document.querySelector('#loading-progress');
            progressBar.style.width = '0%';
            progressBar.style.display = 'block';

            loadDashboardData();
        });

        // Charts objects
        let overallPerformanceChart, schoolPerformanceChart, subjectPerformanceChart,
            genderPerformanceChart, trendsChart, assessmentTypeChart,
            divisionPerformanceChart, absentStudentsChart;

        // Load filter options from the server
        function loadFilterOptions() {
            console.log("Loading filter options...");
            // Show the loading overlay
            document.getElementById('loading-overlay').style.display = 'flex';

            $.ajax({
                url: "{{ url_for('assessment.get_filters') }}",
                type: "GET",
                dataType: "json",
                success: function(data) {
                    console.log("Filter options loaded successfully");

                    // Populate academic years
                    data.academic_years.forEach(function(year) {
                        $('#academic-year-filter').append(new Option(year, year));
                    });

                    // Populate subjects
                    data.subjects.forEach(function(subject) {
                        $('#subject-filter').append(new Option(subject, subject));
                    });

                    // Populate schools
                    data.schools.forEach(function(school) {
                        $('#school-filter').append(new Option(school, school));
                    });

                    // Populate assessment types
                    data.assessment_types.forEach(function(type) {
                        $('#assessment-type-filter').append(new Option(type, type));
                    });

                    // Populate grades
                    data.grades.forEach(function(grade) {
                        $('#grade-filter').append(new Option(grade, grade));
                    });

                    // Populate competency levels
                    data.competency_levels.forEach(function(level) {
                        $('#competency-filter').append(new Option(level, level));
                    });

                    // Populate divisions
                    data.divisions.forEach(function(division) {
                        $('#division-filter').append(new Option(division, division));
                    });

                    // Populate genders
                    data.genders.forEach(function(gender) {
                        $('#gender-filter').append(new Option(gender, gender));
                    });

                    // Set date range if available
                    if (data.date_range.min && data.date_range.max) {
                        $('#date-range-filter').daterangepicker({
                            startDate: moment(data.date_range.min),
                            endDate: moment(data.date_range.max),
                            locale: {
                                format: 'YYYY-MM-DD'
                            }
                        });
                        $('#date-range-filter').val(data.date_range.min + ' to ' + data.date_range.max);
                    }

                    // Load dashboard data after filters are loaded
                    loadDashboardData();
                },
                error: function(xhr, status, error) {
                    console.error("Error loading filter options:", error);
                    alert("Failed to load filter options. Please refresh the page.");
                    document.getElementById('loading-overlay').style.display = 'none';
                },
                complete: function() {
                    // Hide the loading overlay when filters are loaded
                    // We don't hide it here because loadDashboardData will be called next
                    console.log("Filter options request completed");
                }
            });
        }

        // Load dashboard data based on selected filters
        function loadDashboardData() {
            console.log("Loading dashboard data...");

            // Get filter values
            const filters = getFilterValues();

            // Update progress bar
            document.querySelector('#loading-progress').style.width = '10%';
            document.querySelector('#loading-message').textContent = 'Fetching data from server...';

            // Fetch minimal data from server for client-side charts
            $.ajax({
                url: "{{ url_for('assessment.get_dashboard_data') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(filters),
                dataType: "json",
                success: function(data) {
                    console.log("Basic data loaded successfully:", data.length, "records");

                    // Update progress
                    document.querySelector('#loading-progress').style.width = '30%';
                    document.querySelector('#loading-message').textContent = 'Updating summary cards...';

                    // Update summary cards with the data
                    updateSummaryCards(data);

                    // Update progress
                    document.querySelector('#loading-progress').style.width = '40%';
                    document.querySelector('#loading-message').textContent = 'Loading charts...';

                    // Start loading all charts in parallel
                    updateCharts(data);

                    // Hide the loading overlay after a short delay
                    setTimeout(function() {
                        document.getElementById('loading-overlay').style.display = 'none';
                    }, 1000);
                },
                error: function(xhr, status, error) {
                    console.error("Error loading dashboard data:", error);
                    alert("Failed to load dashboard data. Please try again.");
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            });
        }

        // Process and display data
        function processData(data) {
            if (!data || data.length === 0) {
                alert("No data available for the selected filters.");
                return;
            }

            // Update summary cards
            updateSummaryCards(data);

            // Update charts
            updateCharts(data);

            // Update top students table
            updateTopStudentsTable(data);
        }

        // Update summary cards
        function updateSummaryCards(data) {
            // Calculate total unique students
            const uniqueStudents = new Set(data.map(item => item.student_id));
            $('#total-students').text(uniqueStudents.size.toLocaleString());

            // Calculate average score
            const totalPercentage = data.reduce((sum, item) => sum + item.percentage, 0);
            const averageScore = totalPercentage / data.length;
            $('#average-score').text(averageScore.toFixed(2) + '%');

            // Total assessments
            $('#total-assessments').text(data.length.toLocaleString());

            // Total unique schools
            const uniqueSchools = new Set(data.map(item => item.school_name));
            $('#total-schools').text(uniqueSchools.size.toLocaleString());
        }

        // Update all charts
        function updateCharts(data) {
            // Get filter values
            const filters = getFilterValues();

            // Update charts that still use client-side data processing
            updateSummaryCards(data);
            updateAbsentStudentsChart(data);
            updateTopStudentsTable(data);

            // Update charts using server-side processing
            updateOverallPerformanceChart();
            updateSchoolPerformanceChart();
            updateSubjectPerformanceChart();
            updateGenderPerformanceChart();
            updateGradePerformanceChart();
            updateCityGradePerformanceChart();
            updateSchoolGradePerformanceChart();
            updateCitySubjectPerformanceChart();
        }

        // Helper function to get current filter values
        function getFilterValues() {
            const filters = {
                academic_year: $('#academic-year-filter').val(),
                subject: $('#subject-filter').val(),
                school: $('#school-filter').val(),
                assessment_type: $('#assessment-type-filter').val(),
                grade: $('#grade-filter').val(),
                competency_level: $('#competency-filter').val(),
                division: $('#division-filter').val(),
                gender: $('#gender-filter').val()
            };

            // Get date range if selected
            const dateRange = $('#date-range-filter').val();
            if (dateRange) {
                const dates = dateRange.split(' to ');
                if (dates.length === 2) {
                    filters.start_date = dates[0];
                    filters.end_date = dates[1];
                }
            }

            return filters;
        }

        // Update overall student performance chart (pie chart)
        function updateOverallPerformanceChart() {
            // Get filter values
            const filters = getFilterValues();

            // Show loading indicator for this chart
            $('#overall-performance-chart').closest('.card-body').html('<div class="text-center mt-4 mb-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading chart data...</p></div>');

            // Fetch data from server
            $.ajax({
                url: "{{ url_for('assessment.get_overall_performance_chart') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(filters),
                dataType: "json",
                success: function(chartData) {
                    // Create canvas if it doesn't exist
                    $('#overall-performance-chart').closest('.card-body').html('<canvas id="overall-performance-chart"></canvas>');

                    const labels = chartData.labels;
                    const values = chartData.data;
                    const backgroundColors = generateColors(labels.length);

                    // Create new chart
                    const ctx = document.getElementById('overall-performance-chart').getContext('2d');
                    overallPerformanceChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: values,
                                backgroundColor: backgroundColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right'
                                },
                                title: {
                                    display: true,
                                    text: 'Distribution by Competency Level'
                                }
                            }
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Error loading overall performance chart data:", error);
                    $('#overall-performance-chart').closest('.card-body').html('<div class="alert alert-danger">Failed to load chart data. Please try again.</div>');
                }
            });
        }

        // Update school performance chart (bar chart)
        function updateSchoolPerformanceChart() {
            // Get filter values
            const filters = getFilterValues();

            // Show loading indicator for this chart
            $('#school-performance-chart').closest('.card-body').html('<div class="text-center mt-4 mb-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading chart data...</p></div>');

            // Fetch data from server
            $.ajax({
                url: "{{ url_for('assessment.get_school_performance_chart') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(filters),
                dataType: "json",
                success: function(chartData) {
                    // Create canvas if it doesn't exist
                    $('#school-performance-chart').closest('.card-body').html('<canvas id="school-performance-chart"></canvas>');

                    // Create new chart
                    const ctx = document.getElementById('school-performance-chart').getContext('2d');
                    schoolPerformanceChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Average Score (%)',
                                data: chartData.data,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Top 10 Schools by Average Performance'
                                }
                            }
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Error loading school performance chart data:", error);
                    $('#school-performance-chart').closest('.card-body').html('<div class="alert alert-danger">Failed to load chart data. Please try again.</div>');
                }
            });
        }

        // Update subject performance chart (horizontal bar chart)
        function updateSubjectPerformanceChart(data) {
            // Group by subject
            const subjectGroups = {};
            data.forEach(item => {
                const subject = item.subject_name || 'Unknown';
                if (!subjectGroups[subject]) {
                    subjectGroups[subject] = {
                        obtained_total: 0,
                        max_total: 0
                    };
                }
                subjectGroups[subject].obtained_total += parseFloat(item.obtained_marks) || 0;
                subjectGroups[subject].max_total += parseFloat(item.max_marks) || 0;
            });

            // Calculate averages (sum of obtained_marks / sum of max_marks)
            const subjects = [];
            const averages = [];
            Object.entries(subjectGroups).forEach(([subject, stats]) => {
                subjects.push(subject);
                // Calculate percentage as sum(obtained_marks) / sum(max_marks) * 100
                const percentage = stats.max_total > 0 ? (stats.obtained_total / stats.max_total) * 100 : 0;
                averages.push(percentage);
            });

            // Sort by average performance (descending)
            const sortedIndices = averages.map((_, i) => i).sort((a, b) => averages[b] - averages[a]);
            const sortedSubjects = sortedIndices.map(i => subjects[i]);
            const sortedAverages = sortedIndices.map(i => averages[i]);

            // Destroy previous chart if exists
            if (subjectPerformanceChart) {
                subjectPerformanceChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('subject-performance-chart').getContext('2d');
            subjectPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedSubjects,
                    datasets: [{
                        label: 'Average Score (%)',
                        data: sortedAverages,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance by Subject'
                        }
                    }
                }
            });
        }

        // Update gender performance chart (stacked bar chart)
        function updateGenderPerformanceChart(data) {
            // Group by subject and gender
            const subjectGenderGroups = {};
            const genders = new Set();

            data.forEach(item => {
                const subject = item.subject_name || 'Unknown';
                const gender = item.gender || 'Unknown';

                genders.add(gender);

                if (!subjectGenderGroups[subject]) {
                    subjectGenderGroups[subject] = {};
                }

                if (!subjectGenderGroups[subject][gender]) {
                    subjectGenderGroups[subject][gender] = {
                        total: 0,
                        count: 0
                    };
                }

                subjectGenderGroups[subject][gender].total += item.percentage;
                subjectGenderGroups[subject][gender].count++;
            });

            // Get unique subjects and genders
            const subjects = Object.keys(subjectGenderGroups);
            const uniqueGenders = Array.from(genders);

            // Prepare datasets
            const datasets = uniqueGenders.map((gender, index) => {
                const data = subjects.map(subject => {
                    if (subjectGenderGroups[subject][gender]) {
                        return subjectGenderGroups[subject][gender].total / subjectGenderGroups[subject][gender].count;
                    }
                    return 0;
                });

                // Use different colors for different genders
                const colors = {
                    'M': 'rgba(54, 162, 235, 0.6)',
                    'F': 'rgba(255, 99, 132, 0.6)',
                    'Male': 'rgba(54, 162, 235, 0.6)',
                    'Female': 'rgba(255, 99, 132, 0.6)'
                };

                return {
                    label: gender,
                    data: data,
                    backgroundColor: colors[gender] || `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.6)`,
                    borderWidth: 1
                };
            });

            // Destroy previous chart if exists
            if (genderPerformanceChart) {
                genderPerformanceChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('gender-performance-chart').getContext('2d');
            genderPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subjects,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false
                        },
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance by Gender Across Subjects'
                        }
                    }
                }
            });
        }

        // Update trends over time chart (line chart)
        function updateTrendsChart(data) {
            // Group by date
            const dateGroups = {};
            data.forEach(item => {
                if (!item.assessment_date) return;

                // Group by month for better visualization
                const date = item.assessment_date.substring(0, 7); // YYYY-MM format

                if (!dateGroups[date]) {
                    dateGroups[date] = {
                        total: 0,
                        count: 0
                    };
                }

                dateGroups[date].total += item.percentage;
                dateGroups[date].count++;
            });

            // Calculate averages and sort by date
            const dates = Object.keys(dateGroups).sort();
            const averages = dates.map(date => dateGroups[date].total / dateGroups[date].count);

            // Format dates for display
            const formattedDates = dates.map(date => {
                const [year, month] = date.split('-');
                return `${month}/${year}`;
            });

            // Destroy previous chart if exists
            if (trendsChart) {
                trendsChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('trends-chart').getContext('2d');
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedDates,
                    datasets: [{
                        label: 'Average Score (%)',
                        data: averages,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance Trends Over Time'
                        }
                    }
                }
            });
        }

        // Update assessment type comparison chart (bar chart)
        function updateAssessmentTypeChart(data) {
            // Group by assessment type
            const typeGroups = {};
            data.forEach(item => {
                const type = item.assessment_type || 'Unknown';

                if (!typeGroups[type]) {
                    typeGroups[type] = {
                        total: 0,
                        count: 0
                    };
                }

                typeGroups[type].total += item.percentage;
                typeGroups[type].count++;
            });

            // Calculate averages
            const types = Object.keys(typeGroups);
            const averages = types.map(type => typeGroups[type].total / typeGroups[type].count);

            // Destroy previous chart if exists
            if (assessmentTypeChart) {
                assessmentTypeChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('assessment-type-chart').getContext('2d');
            assessmentTypeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: types,
                    datasets: [{
                        label: 'Average Score (%)',
                        data: averages,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance by Assessment Type'
                        }
                    }
                }
            });
        }

        // Update division performance chart (bar chart)
        function updateDivisionPerformanceChart(data) {
            // Group by division
            const divisionGroups = {};
            data.forEach(item => {
                const division = item.division_name || 'Unknown';

                if (!divisionGroups[division]) {
                    divisionGroups[division] = {
                        total: 0,
                        count: 0
                    };
                }

                divisionGroups[division].total += item.percentage;
                divisionGroups[division].count++;
            });

            // Calculate averages
            const divisions = Object.keys(divisionGroups);
            const averages = divisions.map(division => divisionGroups[division].total / divisionGroups[division].count);

            // Destroy previous chart if exists
            if (divisionPerformanceChart) {
                divisionPerformanceChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('division-performance-chart').getContext('2d');
            divisionPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: divisions,
                    datasets: [{
                        label: 'Average Score (%)',
                        data: averages,
                        backgroundColor: 'rgba(255, 206, 86, 0.6)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance by Division'
                        }
                    }
                }
            });
        }

        // Update absent students chart (bar chart)
        function updateAbsentStudentsChart(data) {
            // Group by assessment type and present/absent status
            const statusGroups = {};
            data.forEach(item => {
                const type = item.assessment_type || 'Unknown';
                const status = item.present_absent === 'A' ? 'Absent' : 'Present';

                if (!statusGroups[type]) {
                    statusGroups[type] = {
                        Present: 0,
                        Absent: 0
                    };
                }

                statusGroups[type][status]++;
            });

            // Prepare data for chart
            const types = Object.keys(statusGroups);
            const presentCounts = types.map(type => statusGroups[type].Present);
            const absentCounts = types.map(type => statusGroups[type].Absent);

            // Destroy previous chart if exists
            if (absentStudentsChart) {
                absentStudentsChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('absent-students-chart').getContext('2d');
            absentStudentsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: types,
                    datasets: [
                        {
                            label: 'Present',
                            data: presentCounts,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Absent',
                            data: absentCounts,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false
                        },
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Present vs. Absent Students by Assessment Type'
                        }
                    }
                }
            });
        }

        // Update top students table
        function updateTopStudentsTable(data) {
            // Sort by percentage (descending)
            const sortedData = [...data].sort((a, b) => b.percentage - a.percentage);

            // Get top 10 students
            const topStudents = sortedData.slice(0, 10);

            // Clear table
            const tableBody = $('#top-students-table tbody');
            tableBody.empty();

            // Add rows
            topStudents.forEach(student => {
                tableBody.append(`
                    <tr>
                        <td>${student.student_name || 'N/A'}</td>
                        <td>${student.student_id || 'N/A'}</td>
                        <td>${student.school_name || 'N/A'}</td>
                        <td>${student.subject_name || 'N/A'}</td>
                        <td>${student.grade_name || 'N/A'}</td>
                        <td>${student.obtained_marks || 0} / ${student.max_marks || 0}</td>
                        <td>${student.percentage.toFixed(2)}%</td>
                    </tr>
                `);
            });
        }

        // Helper function to generate colors for charts
        function generateColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const hue = (i * 137) % 360; // Use golden angle for better distribution
                colors.push(`hsl(${hue}, 70%, 60%)`);
            }
            return colors;
        }

        // Update grade performance chart (bar chart)
        function updateGradePerformanceChart(data) {
            // Define grade order for display
            const gradeOrder = ['JR.KG', 'SR.KG', 'GRADE 1', 'GRADE 2', 'GRADE 3', 'GRADE 4', 'GRADE 5', 'GRADE 6', 'GRADE 7', 'GRADE 8', 'GRADE 9', 'GRADE 10'];
            const gradeDisplay = ['Jr.KG', 'Sr.KG', 'Gr. 1', 'Gr. 2', 'Gr. 3', 'Gr. 4', 'Gr. 5', 'Gr. 6', 'Gr. 7', 'Gr. 8', 'Gr. 9', 'Gr. 10'];

            // Group by grade
            const gradeGroups = {};
            data.forEach(item => {
                const grade = item.grade_name || 'Unknown';
                if (!gradeGroups[grade]) {
                    gradeGroups[grade] = {
                        obtained_total: 0,
                        max_total: 0
                    };
                }
                gradeGroups[grade].obtained_total += parseFloat(item.obtained_marks) || 0;
                gradeGroups[grade].max_total += parseFloat(item.max_marks) || 0;
            });

            // Calculate percentages and prepare data for chart
            const grades = [];
            const percentages = [];

            // Process grades in the defined order
            gradeOrder.forEach((grade, index) => {
                if (gradeGroups[grade]) {
                    grades.push(gradeDisplay[index]);
                    const percentage = gradeGroups[grade].max_total > 0 ?
                        (gradeGroups[grade].obtained_total / gradeGroups[grade].max_total) * 100 : 0;
                    percentages.push(percentage.toFixed(0));
                }
            });

            // Create a new div for the chart if it doesn't exist
            if (!document.getElementById('grade-performance-chart')) {
                const chartRow = document.createElement('div');
                chartRow.className = 'row mb-4';
                chartRow.innerHTML = `
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Overall Performance by Grade</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="grade-performance-chart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                // Insert after the first row of charts
                const firstChartRow = document.querySelector('.row.mb-4');
                firstChartRow.parentNode.insertBefore(chartRow, firstChartRow.nextSibling);
            }

            // Create the chart
            const ctx = document.getElementById('grade-performance-chart').getContext('2d');

            // Check if chart already exists and destroy it
            if (window.gradePerformanceChart) {
                window.gradePerformanceChart.destroy();
            }

            // Create new chart
            window.gradePerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: grades,
                    datasets: [{
                        label: 'Average Score (%)',
                        data: percentages,
                        backgroundColor: 'rgba(78, 115, 223, 0.6)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update city-grade performance chart (grouped bar chart)
        function updateCityGradePerformanceChart(data) {
            // Define grade order for display
            const gradeOrder = ['JR.KG', 'SR.KG', 'GRADE 1', 'GRADE 2', 'GRADE 3', 'GRADE 4', 'GRADE 5', 'GRADE 6', 'GRADE 7', 'GRADE 8', 'GRADE 9', 'GRADE 10'];
            const gradeDisplay = ['Jr.KG', 'Sr.KG', 'Gr. 1', 'Gr. 2', 'Gr. 3', 'Gr. 4', 'Gr. 5', 'Gr. 6', 'Gr. 7', 'Gr. 8', 'Gr. 9', 'Gr. 10'];

            // Define cities
            const cities = ['Mumbai', 'Pune', 'Nagpur'];

            // Map schools to cities
            const citySchools = {
                'Mumbai': ['ABMPS', 'DNMPS', 'LNMPS', 'MLMPS', 'NMMC93', 'NNMPS', 'SMCMPS', 'SMPS', 'WBMPS'],
                'Pune': ['ANWEMS', 'BOPEMS', 'CSMEMS', 'KCTVN', 'LAPMEMS', 'LDRKEMS', 'MEMS', 'PKGEMS', 'SBP', 'SBP-MO'],
                'Nagpur': ['LBBNPS', 'BNPS', 'LGMNPS', 'RDNPS', 'RMNPS', 'RNPS']
            };

            // Function to map school to city
            function mapSchoolToCity(school) {
                for (const city in citySchools) {
                    if (citySchools[city].includes(school)) {
                        return city;
                    }
                }
                return 'Other';
            }

            // Group by city and grade
            const cityGradeGroups = {};

            // Initialize structure
            cities.forEach(city => {
                cityGradeGroups[city] = {};
                gradeOrder.forEach(grade => {
                    cityGradeGroups[city][grade] = {
                        obtained_total: 0,
                        max_total: 0
                    };
                });
            });

            // Aggregate data
            data.forEach(item => {
                const school = item.school_name || 'Unknown';
                const grade = item.grade_name || 'Unknown';
                const city = mapSchoolToCity(school);

                if (cities.includes(city) && gradeOrder.includes(grade)) {
                    cityGradeGroups[city][grade].obtained_total += parseFloat(item.obtained_marks) || 0;
                    cityGradeGroups[city][grade].max_total += parseFloat(item.max_marks) || 0;
                }
            });

            // Calculate percentages
            const cityGradePercentages = {};
            cities.forEach(city => {
                cityGradePercentages[city] = {};
                gradeOrder.forEach(grade => {
                    const stats = cityGradeGroups[city][grade];
                    cityGradePercentages[city][grade] = stats.max_total > 0 ?
                        (stats.obtained_total / stats.max_total) * 100 : 0;
                });
            });

            // Prepare data for chart
            const labels = gradeDisplay.filter((_, i) => {
                // Check if any city has data for this grade
                return cities.some(city => cityGradeGroups[city][gradeOrder[i]].max_total > 0);
            });

            const datasets = cities.map((city, index) => {
                const cityData = [];
                gradeOrder.forEach((grade, i) => {
                    if (labels.includes(gradeDisplay[i])) {
                        cityData.push(cityGradePercentages[city][grade].toFixed(0));
                    }
                });

                // Colors for each city
                const colors = {
                    'Mumbai': 'rgba(54, 162, 235, 0.6)',
                    'Pune': 'rgba(255, 99, 132, 0.6)',
                    'Nagpur': 'rgba(255, 206, 86, 0.6)'
                };

                return {
                    label: city,
                    data: cityData,
                    backgroundColor: colors[city],
                    borderColor: colors[city].replace('0.6', '1'),
                    borderWidth: 1
                };
            });

            // Create a new div for the chart if it doesn't exist
            if (!document.getElementById('city-grade-performance-chart')) {
                const chartRow = document.createElement('div');
                chartRow.className = 'row mb-4';
                chartRow.innerHTML = `
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Performance by City and Grade</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="city-grade-performance-chart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                // Insert after the grade performance chart
                const gradeChartCard = document.getElementById('grade-performance-chart').closest('.card').closest('.row');
                gradeChartCard.parentNode.insertBefore(chartRow, gradeChartCard.nextSibling);
            }

            // Create the chart
            const ctx = document.getElementById('city-grade-performance-chart').getContext('2d');

            // Check if chart already exists and destroy it
            if (window.cityGradePerformanceChart) {
                window.cityGradePerformanceChart.destroy();
            }

            // Create new chart
            window.cityGradePerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update school-grade performance chart (heatmap)
        function updateSchoolGradePerformanceChart(data) {
            // Define grade order for display
            const gradeOrder = ['JR.KG', 'SR.KG', 'GRADE 1', 'GRADE 2', 'GRADE 3', 'GRADE 4', 'GRADE 5', 'GRADE 6', 'GRADE 7', 'GRADE 8', 'GRADE 9', 'GRADE 10'];
            const gradeDisplay = ['Jr.KG', 'Sr.KG', 'Gr. 1', 'Gr. 2', 'Gr. 3', 'Gr. 4', 'Gr. 5', 'Gr. 6', 'Gr. 7', 'Gr. 8', 'Gr. 9', 'Gr. 10'];

            // Map schools to cities
            const citySchools = {
                'Mumbai': ['ABMPS', 'DNMPS', 'LNMPS', 'MLMPS', 'NMMC93', 'NNMPS', 'SMCMPS', 'SMPS', 'WBMPS'],
                'Pune': ['ANWEMS', 'BOPEMS', 'CSMEMS', 'KCTVN', 'LAPMEMS', 'LDRKEMS', 'MEMS', 'PKGEMS', 'SBP', 'SBP-MO'],
                'Nagpur': ['LBBNPS', 'BNPS', 'LGMNPS', 'RDNPS', 'RMNPS', 'RNPS']
            };

            // Flatten the school list
            const allSchools = Object.values(citySchools).flat();

            // Group by school and grade
            const schoolGradeGroups = {};

            // Initialize structure
            allSchools.forEach(school => {
                schoolGradeGroups[school] = {};
                gradeOrder.forEach(grade => {
                    schoolGradeGroups[school][grade] = {
                        obtained_total: 0,
                        max_total: 0
                    };
                });
            });

            // Aggregate data
            data.forEach(item => {
                const school = item.school_name || 'Unknown';
                const grade = item.grade_name || 'Unknown';

                if (allSchools.includes(school) && gradeOrder.includes(grade)) {
                    schoolGradeGroups[school][grade].obtained_total += parseFloat(item.obtained_marks) || 0;
                    schoolGradeGroups[school][grade].max_total += parseFloat(item.max_marks) || 0;
                }
            });

            // Calculate percentages and prepare data for table
            const tableData = [];

            allSchools.forEach(school => {
                const rowData = { school: school };

                gradeOrder.forEach((grade, i) => {
                    const stats = schoolGradeGroups[school][grade];
                    const percentage = stats.max_total > 0 ?
                        (stats.obtained_total / stats.max_total) * 100 : null;

                    if (percentage !== null) {
                        rowData[gradeDisplay[i]] = percentage.toFixed(0) + '%';
                    } else {
                        rowData[gradeDisplay[i]] = '-';
                    }
                });

                tableData.push(rowData);
            });

            // Create a new div for the table if it doesn't exist
            if (!document.getElementById('school-grade-performance-table')) {
                const tableRow = document.createElement('div');
                tableRow.className = 'row mb-4';
                tableRow.innerHTML = `
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Performance by School and Grade</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="school-grade-performance-table" class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>School</th>
                                                ${gradeDisplay.map(grade => `<th>${grade}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Insert after the city-grade performance chart
                const cityGradeChartCard = document.getElementById('city-grade-performance-chart').closest('.card').closest('.row');
                cityGradeChartCard.parentNode.insertBefore(tableRow, cityGradeChartCard.nextSibling);
            }

            // Populate the table
            const tableBody = document.querySelector('#school-grade-performance-table tbody');
            tableBody.innerHTML = '';

            tableData.forEach(rowData => {
                const row = document.createElement('tr');

                // Add school name
                const schoolCell = document.createElement('td');
                schoolCell.textContent = rowData.school;
                row.appendChild(schoolCell);

                // Add grade data
                gradeDisplay.forEach(grade => {
                    const cell = document.createElement('td');
                    cell.textContent = rowData[grade] || '-';

                    // Add color based on percentage
                    if (rowData[grade] && rowData[grade] !== '-') {
                        const percentage = parseFloat(rowData[grade]);
                        if (percentage >= 75) {
                            cell.style.backgroundColor = 'rgba(40, 167, 69, 0.2)';
                        } else if (percentage >= 50) {
                            cell.style.backgroundColor = 'rgba(255, 193, 7, 0.2)';
                        } else if (percentage >= 25) {
                            cell.style.backgroundColor = 'rgba(255, 128, 0, 0.2)';
                        } else {
                            cell.style.backgroundColor = 'rgba(220, 53, 69, 0.2)';
                        }
                    }

                    row.appendChild(cell);
                });

                tableBody.appendChild(row);
            });
        }

        // Update city-subject performance chart
        function updateCitySubjectPerformanceChart(data) {
            // Define subject order
            const subjectOrder = ['Math', 'English', 'Hindi', 'Marathi', 'Science', 'Computer'];
            const subjectDisplay = ['Mat', 'Eng', 'Hin', 'Mar', 'Sci', 'Com'];

            // Map subject names to standardized names
            function standardizeSubject(subject) {
                subject = subject.toLowerCase();
                if (subject.includes('math')) return 'Math';
                if (subject.includes('english')) return 'English';
                if (subject.includes('hindi')) return 'Hindi';
                if (subject.includes('marathi')) return 'Marathi';
                if (subject.includes('science')) return 'Science';
                if (subject.includes('computer')) return 'Computer';
                return subject;
            }

            // Define cities
            const cities = ['Mumbai', 'Pune', 'Nagpur', 'Akanksha'];

            // Map schools to cities
            const citySchools = {
                'Mumbai': ['ABMPS', 'DNMPS', 'LNMPS', 'MLMPS', 'NMMC93', 'NNMPS', 'SMCMPS', 'SMPS', 'WBMPS'],
                'Pune': ['ANWEMS', 'BOPEMS', 'CSMEMS', 'KCTVN', 'LAPMEMS', 'LDRKEMS', 'MEMS', 'PKGEMS', 'SBP', 'SBP-MO'],
                'Nagpur': ['LBBNPS', 'BNPS', 'LGMNPS', 'RDNPS', 'RMNPS', 'RNPS']
            };

            // Function to map school to city
            function mapSchoolToCity(school) {
                for (const city in citySchools) {
                    if (citySchools[city].includes(school)) {
                        return city;
                    }
                }
                return 'Other';
            }

            // Group by city and subject
            const citySubjectGroups = {};

            // Initialize structure for all cities including Akanksha (all schools)
            cities.forEach(city => {
                citySubjectGroups[city] = {};
                subjectOrder.forEach(subject => {
                    citySubjectGroups[city][subject] = {
                        obtained_total: 0,
                        max_total: 0
                    };
                });
            });

            // Aggregate data
            data.forEach(item => {
                const school = item.school_name || 'Unknown';
                const rawSubject = item.subject_name || 'Unknown';
                const subject = standardizeSubject(rawSubject);
                const city = mapSchoolToCity(school);

                if (subjectOrder.includes(subject)) {
                    // Add to specific city
                    if (cities.includes(city)) {
                        citySubjectGroups[city][subject].obtained_total += parseFloat(item.obtained_marks) || 0;
                        citySubjectGroups[city][subject].max_total += parseFloat(item.max_marks) || 0;
                    }

                    // Add to Akanksha (all schools)
                    citySubjectGroups['Akanksha'][subject].obtained_total += parseFloat(item.obtained_marks) || 0;
                    citySubjectGroups['Akanksha'][subject].max_total += parseFloat(item.max_marks) || 0;
                }
            });

            // Calculate percentages
            const citySubjectPercentages = {};
            cities.forEach(city => {
                citySubjectPercentages[city] = {};
                subjectOrder.forEach(subject => {
                    const stats = citySubjectGroups[city][subject];
                    citySubjectPercentages[city][subject] = stats.max_total > 0 ?
                        (stats.obtained_total / stats.max_total) * 100 : null;
                });
            });

            // Create a new div for the table if it doesn't exist
            if (!document.getElementById('city-subject-performance-table')) {
                const tableRow = document.createElement('div');
                tableRow.className = 'row mb-4';
                tableRow.innerHTML = `
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Performance by City and Subject</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="city-subject-performance-table" class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>City</th>
                                                ${subjectDisplay.map(subject => `<th>${subject}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Insert after the school-grade performance table
                const schoolGradeTable = document.getElementById('school-grade-performance-table').closest('.card').closest('.row');
                schoolGradeTable.parentNode.insertBefore(tableRow, schoolGradeTable.nextSibling);
            }

            // Populate the table
            const tableBody = document.querySelector('#city-subject-performance-table tbody');
            tableBody.innerHTML = '';

            // Add Akanksha row first, then other cities
            const orderedCities = ['Akanksha', 'Mumbai', 'Pune', 'Nagpur'];

            orderedCities.forEach(city => {
                if (citySubjectPercentages[city]) {
                    const row = document.createElement('tr');

                    // Add city name
                    const cityCell = document.createElement('td');
                    cityCell.textContent = city;
                    row.appendChild(cityCell);

                    // Add subject data
                    subjectOrder.forEach(subject => {
                        const cell = document.createElement('td');
                        const percentage = citySubjectPercentages[city][subject];

                        if (percentage !== null) {
                            cell.textContent = percentage.toFixed(0) + '%';

                            // Add color based on percentage
                            if (percentage >= 75) {
                                cell.style.backgroundColor = 'rgba(40, 167, 69, 0.2)';
                            } else if (percentage >= 50) {
                                cell.style.backgroundColor = 'rgba(255, 193, 7, 0.2)';
                            } else if (percentage >= 25) {
                                cell.style.backgroundColor = 'rgba(255, 128, 0, 0.2)';
                            } else {
                                cell.style.backgroundColor = 'rgba(220, 53, 69, 0.2)';
                            }
                        } else {
                            cell.textContent = '-';
                        }

                        row.appendChild(cell);
                    });

                    tableBody.appendChild(row);
                }
            });
        }
    });
</script>
{% endblock %}
